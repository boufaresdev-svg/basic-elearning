<div class="course-container">
  <!-- Debug Info -->
  <div style="position: fixed; top: 0; left: 0; background: white; padding: 10px; z-index: 9999; font-size: 12px;">
    <div>isLoading: {{ isLoading }}</div>
    <div>course: {{ course ? 'exists' : 'null' }}</div>
    <div>showAccessKeyInput: {{ showAccessKeyInput }}</div>
    <div>isAccessGranted: {{ isAccessGranted }}</div>
  </div>

  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-container">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <span>Chargement du cours...</span>
      </div>
    </div>
  }

  <!-- Error State -->
  @if (errorMessage && !course) {
    <div class="error-container">
      <div class="error-message">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <h2>Erreur</h2>
        <p>{{ errorMessage }}</p>
        <button (click)="goBack()" class="btn btn-primary">
          Retour aux formations
        </button>
      </div>
    </div>
  }

  <!-- Course Loaded -->
  @if (course && !isLoading) {
    <!-- Access Key Input -->
    @if (showAccessKeyInput && !isAccessGranted) {
      <div class="access-key-container">
        <div class="access-key-modal">
          <div class="modal-header">
            <h2>Accès au Cours</h2>
            <button (click)="goBack()" class="close-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>

          <div class="modal-body">
            <div class="course-info">
              <h3>{{ course.title }}</h3>
              <p class="course-category">{{ getCategoryLabel() }}</p>
              <p class="course-description">{{ course.description }}</p>
            </div>

            <div class="access-form">
              <div class="lock-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z"/>
                </svg>
              </div>

              <p class="access-message">Ce cours nécessite une clé d'accès pour être consulté.</p>

              <div class="form-group">
                <label for="access-key">Clé d'accès</label>
                <input
                  type="text"
                  id="access-key"
                  [(ngModel)]="accessKey"
                  (keypress)="onKeyPress($event)"
                  placeholder="Entrez votre clé d'accès"
                  class="form-input"
                  [class.error]="errorMessage"
                />
                @if (errorMessage) {
                  <span class="error-text">{{ errorMessage }}</span>
                }
              </div>

              <div class="form-actions">
                <button (click)="validateAccessKey()" class="btn btn-primary btn-block">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M9 12l2 2 4-4"></path>
                  </svg>
                  Accéder au Cours
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Course Content -->
    @if (isAccessGranted && currentModule) {
      <!-- Course Header -->
      <div class="course-header">
        <div class="course-header-content">
          <button (click)="goBack()" class="back-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="m12 19-7-7 7-7"></path>
              <path d="m19 12-7 7-7-7"></path>
            </svg>
            Retour
          </button>

          <div class="course-info">
            <h1>{{ course.title }}</h1>
            <p class="course-meta">
              <span class="category">{{ getCategoryLabel() }}</span>
              <span class="separator">•</span>
              <span class="modules-count">{{ course.contents.length }} modules</span>
            </p>
          </div>

          <!-- Progress Bar -->
          <div class="progress-container">
            <div class="progress-info">
              <span>Module {{ currentModuleIndex + 1 }} sur {{ course.contents.length }}</span>
              <span>{{ getCourseProgress() }}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="getCourseProgress()"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="content-area">
        <!-- Sidebar: Module Navigation -->
        <aside class="modules-sidebar">
          <div class="sidebar-header">
            <h3>Modules du Cours</h3>
          </div>

          <div class="modules-list">
            @for (module of course.contents; track module.id; let i = $index) {
              <button
                (click)="loadModule(i)"
                [class.active]="i === currentModuleIndex"
                class="module-item">
                <div class="module-number">{{ i + 1 }}</div>
                <div class="module-content">
                  <div class="module-title">{{ module.title }}</div>
                  <div class="module-meta">
                    <span class="module-icon">{{ getModuleTypeIcon(module) }}</span>
                    @if (module.duration) {
                      <span class="module-duration">{{ module.duration }}</span>
                    }
                  </div>
                </div>
                @if (i === currentModuleIndex) {
                  <div class="current-indicator">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                      <polygon points="5,3 19,12 5,21"></polygon>
                    </svg>
                  </div>
                }
              </button>
            }
          </div>
        </aside>

        <!-- Main Content -->
        <main class="module-content">
          <!-- Module Header -->
          <div class="module-header">
            <h2>{{ currentModule.title }}</h2>
            <p class="module-description">{{ currentModule.description }}</p>

            <!-- Media Controls -->
            <div class="media-controls">
              @if (currentModule.video_url) {
                <button
                  (click)="toggleVideo()"
                  [class.active]="showVideo"
                  class="media-btn video-btn">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <polygon points="5,3 19,12 5,21"></polygon>
                  </svg>
                  Vidéo
                </button>
              }

              @if (currentModule.pdf_url) {
                <button
                  (click)="togglePdf()"
                  [class.active]="showPdf"
                  class="media-btn pdf-btn">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                    <polyline points="13 2 13 9 20 9"></polyline>
                  </svg>
                  Document PDF
                </button>
              }
            </div>
          </div>

          <!-- Media Display -->
          <div class="media-content">
            <!-- Video Player -->
            @if (showVideo && currentVideoUrl) {
              <div class="video-container">
                <iframe
                  [src]="currentVideoUrl"
                  frameborder="0"
                  allowfullscreen
                  class="video-player">
                </iframe>
              </div>
            }

            <!-- PDF Viewer -->
            @if (showPdf && currentPdfUrl) {
              <div class="pdf-container">
                <iframe
                  [src]="currentPdfUrl"
                  frameborder="0"
                  class="pdf-viewer">
                </iframe>
                <div class="pdf-actions">
                  <a [href]="currentModule.pdf_url" target="_blank" class="btn btn-secondary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M21 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h6"></path>
                      <path d="M21 3l-6 6"></path>
                      <path d="M15 3h6v6"></path>
                    </svg>
                    Ouvrir dans un nouvel onglet
                  </a>
                </div>
              </div>
            }

            <!-- Default Content (when no media is selected) -->
            @if (!showVideo && !showPdf) {
              <div class="default-content">
                <div class="content-placeholder">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                  </svg>
                  <h3>Contenu du Module</h3>
                  <p>{{ currentModule.description }}</p>

                  @if (currentModule.video_url || currentModule.pdf_url) {
                    <p class="media-hint">
                      Utilisez les boutons ci-dessus pour accéder au contenu multimédia de ce module.
                    </p>
                  } @else {
                    <p class="no-media">Aucun contenu multimédia disponible pour ce module.</p>
                  }
                </div>
              </div>
            }
          </div>

          <!-- Module Navigation -->
          <div class="module-navigation">
            <button
              (click)="previousModule()"
              [disabled]="currentModuleIndex === 0"
              class="nav-btn prev-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="m15 18-6-6 6-6"></path>
              </svg>
              Module Précédent
            </button>

            <div class="module-indicator">
              {{ currentModuleIndex + 1 }} / {{ course.contents.length }}
            </div>

            <button
              (click)="nextModule()"
              [disabled]="currentModuleIndex === course.contents.length - 1"
              class="nav-btn next-btn">
              Module Suivant
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="m9 18 6-6-6-6"></path>
              </svg>
            </button>
          </div>
        </main>
      </div>
    }

    <!-- Course loaded but no modules -->
    @if (isAccessGranted && (!course.contents || course.contents.length === 0)) {
      <div class="empty-course">
        <div class="empty-content">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
          </svg>
          <h2>Cours Vide</h2>
          <p>Ce cours ne contient aucun module pour le moment.</p>
          <button (click)="goBack()" class="btn btn-primary">
            Retour aux formations
          </button>
        </div>
      </div>
    }
  }
</div>
