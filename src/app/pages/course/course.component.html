<div class="course-container">

  @if (isLoading) {
    <div class="loading-container">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <span>Chargement du cours...</span>
      </div>
    </div>
  }

  <!-- Error State -->
  @if (errorMessage && !course) {
    <div class="error-container">
      <div class="error-message">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <h2>Erreur</h2>
        <p>{{ errorMessage }}</p>
        <button (click)="goBack()" class="btn btn-primary">
          Retour aux formations
        </button>
      </div>
    </div>
  }

  <!-- Course Loaded -->
  @if (course && !isLoading) {
    <!-- Access Key Input -->
    @if (showAccessKeyInput && !isAccessGranted) {
      <div class="access-key-container">
        <div class="access-key-modal">
          <div class="modal-header">
            <h2>Accès au Cours</h2>
            <button (click)="goBack()" class="close-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>

          <div class="modal-body">
            <div class="course-info">
              <h3>{{ course.title }}</h3>
              <p class="course-category">{{ getCategoryLabel() }}</p>
              <p class="course-description">{{ course.description }}</p>
            </div>

            <div class="access-form">
              <div class="lock-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z"/>
                </svg>
              </div>

              <p class="access-message">Ce cours nécessite une clé d'accès pour être consulté.</p>

              <div class="form-group">
                <label for="access-key">Clé d'accès</label>
                <input
                  type="text"
                  id="access-key"
                  [(ngModel)]="accessKey"
                  (keypress)="onKeyPress($event)"
                  placeholder="Entrez votre clé d'accès"
                  class="form-input"
                  [class.error]="errorMessage"
                />
                @if (errorMessage) {
                  <span class="error-text">{{ errorMessage }}</span>
                }
              </div>

              <div class="form-actions">
                <button (click)="validateAccessKey()" class="btn btn-primary btn-block">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M9 12l2 2 4-4"></path>
                  </svg>
                  Accéder au Cours
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Course Content -->
    @if (isAccessGranted && currentModule) {
      <!-- Course Header -->
      <div class="course-header">
        <div class="course-header-content">
          <button (click)="goBack()" class="back-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="m12 19-7-7 7-7"></path>
              <path d="m19 12-7 7-7-7"></path>
            </svg>
            Retour
          </button>

          <div class="course-info">
            <h1>{{ course.title }}</h1>
            <p class="course-meta">
              <span class="category">{{ getCategoryLabel() }}</span>
              <span class="separator">•</span>
              <span class="modules-count">{{ course.contents.length }} modules</span>
            </p>
          </div>

          <!-- Progress Bar -->
          <div class="progress-container">
            <div class="progress-info">
              <span>Module {{ currentModuleIndex + 1 }} sur {{ course.contents.length }}</span>
              <span>{{ getCourseProgress() }}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="getCourseProgress()"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="content-area">
        <!-- Sidebar: Module Navigation -->
        <aside class="modules-sidebar">
          <div class="sidebar-header">
            <h3>Modules du Cours</h3>
          </div>

          <div class="modules-list">
            @for (module of course.contents; track module.id; let i = $index) {
              <button
                (click)="loadModule(i)"
                [class.active]="i === currentModuleIndex"
                class="module-item">
                <div class="module-number">{{ i + 1 }}</div>
                <div class="module-content">
                  <div class="module-title">{{ module.title }}</div>
                  <div class="module-meta">
                    <span class="module-icon">{{ getModuleTypeIcon(module) }}</span>
                    @if (module.duration) {
                      <span class="module-duration">{{ module.duration }}</span>
                    }
                  </div>
                </div>
                @if (i === currentModuleIndex) {
                  <div class="current-indicator">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                      <polygon points="5,3 19,12 5,21"></polygon>
                    </svg>
                  </div>
                }
              </button>
            }
          </div>
        </aside>

        <!-- Main Content -->
        <main class="module-content">
          <!-- Module Header -->
          <div class="module-header">
            <h2>{{ currentModule.title }}</h2>
            <div class="module-description" [innerHTML]="currentModule.description"></div>

            <!-- Content Type Badges -->
            @if (currentModule.video_url || currentModule.pdf_url || currentModule.quiz) {
              <div class="content-badges">
                @if (currentModule.video_url) {
                  <span class="content-badge video">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <polygon points="5,3 19,12 5,21"></polygon>
                    </svg>
                    Vidéo disponible
                  </span>
                }
                @if (currentModule.pdf_url) {
                  <span class="content-badge pdf">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                      <polyline points="13 2 13 9 20 9"></polyline>
                    </svg>
                    Document PDF
                  </span>
                }
                @if (currentModule.quiz) {
                  <span class="content-badge quiz">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M9 11H3v2h6v-2zm12 0h-6v2h6v-2zm-3-7h-2V2h-4v2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H8V6h8v12z"></path>
                    </svg>
                    Quiz disponible
                  </span>
                }
              </div>
            }

            <!-- Media Controls -->
            <div class="media-controls">
              @if (currentModule.video_url) {
                <button
                  (click)="toggleVideo()"
                  [class.active]="showVideo"
                  class="media-btn video-btn">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <polygon points="5,3 19,12 5,21"></polygon>
                  </svg>
                  Vidéo
                </button>
              }

              @if (currentModule.pdf_url) {
                <button
                  (click)="togglePdf()"
                  [class.active]="showPdf"
                  class="media-btn pdf-btn">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                    <polyline points="13 2 13 9 20 9"></polyline>
                  </svg>
                  Document PDF
                </button>
              }

              @if (currentModule.quiz && !isQuizActive && !showQuizResults) {
                <button
                  (click)="startQuiz()"
                  class="media-btn quiz-btn">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M9 11H3v2h6v-2zm12 0h-6v2h6v-2zm-3-7h-2V2h-4v2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H8V6h8v12z"></path>
                  </svg>
                  Commencer le Quiz
                </button>
              }
            </div>
          </div>

          <!-- Media Display -->
          <div class="media-content">
            <!-- Video Player -->
            @if (showVideo && currentVideoUrl) {
              <div class="video-container">
                <iframe
                  [src]="currentVideoUrl"
                  frameborder="0"
                  allowfullscreen
                  class="video-player">
                </iframe>
              </div>
            }

            <!-- PDF Viewer -->
            @if (showPdf && currentPdfUrl) {
              <div class="pdf-container">
                <iframe
                  [src]="currentPdfUrl"
                  frameborder="0"
                  class="pdf-viewer">
                </iframe>
                <div class="pdf-actions">
                  <a [href]="currentModule.pdf_url" target="_blank" class="btn btn-secondary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M21 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h6"></path>
                      <path d="M21 3l-6 6"></path>
                      <path d="M15 3h6v6"></path>
                    </svg>
                    Ouvrir dans un nouvel onglet
                  </a>
                </div>
              </div>
            }

            <!-- Default Content (when no media is selected) -->
            @if (!showVideo && !showPdf && !isQuizActive && !showQuizResults) {
              <div class="default-content">
                <div class="content-placeholder">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                  </svg>
                  <h3>Contenu du Module</h3>
                  <div [innerHTML]="currentModule.description"></div>

                  @if (currentModule.video_url || currentModule.pdf_url || currentModule.quiz) {
                    <p class="media-hint">
                      Utilisez les boutons ci-dessus pour accéder au contenu de ce module.
                    </p>
                  } @else {
                    <p class="no-media">Aucun contenu disponible pour ce module.</p>
                  }
                </div>
              </div>
            }

            <!-- Quiz Active -->
            @if (isQuizActive && currentQuiz) {
              <div class="quiz-container">
                <!-- Quiz Header -->
                <div class="quiz-header">
                  <div class="quiz-info">
                    <h3>{{ currentQuiz.title }}</h3>
                    <p>{{ currentQuiz.description }}</p>
                    <div class="quiz-meta">
                      <span class="quiz-meta-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <circle cx="12" cy="12" r="10"></circle>
                          <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        {{ currentQuiz.questions.length }} questions
                      </span>
                      @if (currentQuiz.timeLimit) {
                        <span class="quiz-meta-item timer">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                          </svg>
                          Temps restant: {{ getQuizTimerDisplay() }}
                        </span>
                      }
                      <span class="quiz-meta-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                        </svg>
                        Score de passage: {{ currentQuiz.passingScore }}%
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Quiz Questions -->
                <div class="quiz-questions">
                  @for (question of currentQuiz.questions; track question.id; let i = $index) {
                    <div class="quiz-question-card">
                      <div class="question-header">
                        <span class="question-number">Question {{ i + 1 }}</span>
                        <span class="question-points">{{ question.points }} points</span>
                      </div>

                      <h4 class="question-text">{{ question.question }}</h4>

                      <!-- Multiple Choice -->
                      @if (question.type === 'multiple-choice' && question.options) {
                        <div class="question-options">
                          @for (option of question.options; track option) {
                            <label class="option-label">
                              <input
                                type="radio"
                                [name]="'question-' + question.id"
                                [value]="option"
                                [checked]="isOptionSelected(question.id, option)"
                                (change)="selectAnswer(question.id, option)"
                              />
                              <span>{{ option }}</span>
                            </label>
                          }
                        </div>
                      }

                      <!-- True/False -->
                      @if (question.type === 'true-false') {
                        <div class="question-options">
                          <label class="option-label">
                            <input
                              type="radio"
                              [name]="'question-' + question.id"
                              value="true"
                              [checked]="isOptionSelected(question.id, 'true')"
                              (change)="selectAnswer(question.id, 'true')"
                            />
                            <span>Vrai</span>
                          </label>
                          <label class="option-label">
                            <input
                              type="radio"
                              [name]="'question-' + question.id"
                              value="false"
                              [checked]="isOptionSelected(question.id, 'false')"
                              (change)="selectAnswer(question.id, 'false')"
                            />
                            <span>Faux</span>
                          </label>
                        </div>
                      }

                      <!-- Short Answer -->
                      @if (question.type === 'short-answer') {
                        <div class="question-input">
                          <input
                            type="text"
                            class="form-input"
                            placeholder="Votre réponse..."
                            [(ngModel)]="quizAnswers[question.id]"
                          />
                        </div>
                      }
                    </div>
                  }
                </div>

                <!-- Quiz Actions -->
                <div class="quiz-actions">
                  <button (click)="exitQuiz()" class="btn btn-secondary">
                    Quitter
                  </button>
                  <button
                    (click)="submitQuiz()"
                    [disabled]="!canSubmitQuiz()"
                    class="btn btn-primary">
                    Soumettre le Quiz
                  </button>
                </div>
              </div>
            }

            <!-- Quiz Results -->
            @if (showQuizResults && currentQuiz) {
              <div class="quiz-results">
                <div class="results-header" [class.passed]="quizPassed" [class.failed]="!quizPassed">
                  <div class="results-icon">
                    @if (quizPassed) {
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                      </svg>
                    } @else {
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                      </svg>
                    }
                  </div>
                  <h3>{{ quizPassed ? 'Félicitations !' : 'Essayez encore' }}</h3>
                  <p class="results-score">
                    {{ quizScore }} / {{ quizTotalPoints }} points ({{ getQuizPercentage() }}%)
                  </p>
                  <p class="results-status">
                    @if (quizPassed) {
                      Vous avez réussi ce quiz avec succès !
                    } @else {
                      Vous avez besoin d'au moins {{ currentQuiz.passingScore }}% pour réussir.
                    }
                  </p>
                </div>

                <!-- Show Correct Answers (if enabled) -->
                @if (currentQuiz.showCorrectAnswers) {
                  <div class="results-details">
                    <h4>Résultats Détaillés</h4>
                    @for (question of currentQuiz.questions; track question.id; let i = $index) {
                      <div class="result-question" [class.correct]="isAnswerCorrect(question.id)" [class.incorrect]="!isAnswerCorrect(question.id)">
                        <div class="result-question-header">
                          <span class="result-icon">
                            @if (isAnswerCorrect(question.id)) {
                              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <polyline points="20 6 9 17 4 12"></polyline>
                              </svg>
                            } @else {
                              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                              </svg>
                            }
                          </span>
                          <span class="result-question-title">Question {{ i + 1 }}</span>
                          <span class="result-points">{{ getQuestionScore(question.id) }} / {{ question.points }} pts</span>
                        </div>
                        <p class="result-question-text">{{ question.question }}</p>
                        <div class="result-answers">
                          <p><strong>Votre réponse:</strong> {{ quizAnswers[question.id] }}</p>
                          <p><strong>Réponse correcte:</strong> {{ question.correctAnswer }}</p>
                          @if (question.explanation) {
                            <p class="result-explanation"><strong>Explication:</strong> {{ question.explanation }}</p>
                          }
                        </div>
                      </div>
                    }
                  </div>
                }

                <!-- Results Actions -->
                <div class="results-actions">
                  <button (click)="exitQuiz()" class="btn btn-secondary">
                    Continuer le Cours
                  </button>
                  @if (currentQuiz.allowRetake && !quizPassed) {
                    <button (click)="retakeQuiz()" class="btn btn-primary">
                      Reprendre le Quiz
                    </button>
                  }
                </div>
              </div>
            }
          </div>

          <!-- Module Navigation -->
          <div class="module-navigation">
            <button
              (click)="previousModule()"
              [disabled]="currentModuleIndex === 0"
              class="nav-btn prev-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="m15 18-6-6 6-6"></path>
              </svg>
              Module Précédent
            </button>

            <div class="module-indicator">
              {{ currentModuleIndex + 1 }} / {{ course.contents.length }}
            </div>

            <button
              (click)="nextModule()"
              [disabled]="currentModuleIndex === course.contents.length - 1"
              class="nav-btn next-btn">
              Module Suivant
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="m9 18 6-6-6-6"></path>
              </svg>
            </button>
          </div>
        </main>
      </div>
    }

    <!-- Course loaded but no modules -->
    @if (isAccessGranted && (!course.contents || course.contents.length === 0)) {
      <div class="empty-course">
        <div class="empty-content">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
          </svg>
          <h2>Cours Vide</h2>
          <p>Ce cours ne contient aucun module pour le moment.</p>
          <button (click)="goBack()" class="btn btn-primary">
            Retour aux formations
          </button>
        </div>
      </div>
    }
  }
</div>
